<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007acc">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function() {
        navigator.serviceWorker.register("service-worker.js");
      });
    }
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=yes">
  <title>道路ツール</title>
  <style>
    html, body {
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      font-size: 18px;
      font-family: sans-serif;
      width: 100vw;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .project-bar {
      width: 100vw;
      background: #e3f2fd;
      border-bottom: 2px solid #007acc;
      padding: 8px 8px 8px 8px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .project-bar label {
      font-size: 1em;
      color: #007acc;
      font-weight: bold;
      margin-right: 4px;
    }
    .project-bar select {
      font-size: 1em;
      padding: 5px 10px;
      border-radius: 5px;
    }
    .tabbar {
      display: flex;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
      width: 100vw;
      background: #164361;
      border-bottom: 2px solid #007acc;
      box-sizing: border-box;
      z-index: 90;
      scrollbar-width: thin;
      padding-bottom: 4px;
      gap: 6px;
    }
    .tabbar button {
      flex: 0 0 auto;
      min-width: 90px;
      white-space: nowrap;
      font-size: 0.95em;
      padding: 10px 16px;
      border: none;
      background: #164361;
      color: #fff;
      border-bottom: 4px solid transparent;
      transition: border-bottom .2s, background .15s;
      font-weight: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 0;
    }
    .tabbar button.active {
      background: #007acc;
      color: #fff;
      border-bottom: 4px solid #ffdc57;
      font-weight: bold;
    }
    .tabbar::-webkit-scrollbar {
      display: none;
    }
    .main-content {
      width: 100vw;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }
    .container {
      display: none;
      width: 100vw;
      box-sizing: border-box;
      margin: 0 auto;
      padding: 10px 0 40px 0;
    }
    .container.active { display: block; }
    input, select, textarea {
      font-size: 1.05em;
      padding: 8px 10px;
      border-radius: 5px;
      border: 1px solid #bbb;
      margin: 2px 0;
      box-sizing: border-box;
    }
    table {
      border-collapse: collapse;
      margin: 12px 0 0 0;
      background: #fff;
      width: 100vw;
      max-width: 100vw;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 7px 4px;
      font-size: 1em;
      text-align: center;
      min-width: 56px;
    }
    th {
      background: #e3f2fd;
      font-weight: bold;
      font-size: 1.04em;
    }
    .survey-table input[type="text"],
    .survey-table input[type="number"] {
      width: 90%;
      min-width: 55px;
      max-width: 160px;
      font-size: 1.06em;
      padding: 7px 6px;
    }
    .buttons {
      margin-top: 14px;
      display: flex;
      gap: 12px;
    }
    .buttons button, .danger-btn, .warn-btn {
      font-size: 1em;
      border-radius: 7px;
      font-weight: bold;
      padding: 10px 19px;
      border: none;
      cursor: pointer;
      background: #007acc;
      color: #fff;
      transition: background .15s;
    }
    .danger-btn { background: #e53935; }
    .warn-btn   { background: #ffc107; color: #333;}
    .delete-btn { background: #e53935; color:white;}
    .add-btn {
      background: #007acc;
      color: #fff;
      font-weight: bold;
      border-radius: 7px;
      padding: 10px 32px;
      border: none;
      margin: 0 10px;
      font-size: 1em;
      text-align: center;
      display: inline-block;
    }
    .record { background: #fff; padding: 8px 2px; margin: 10px 0; border: 1px solid #ccc; font-size: 0.97em;}
    #log h3 { margin-bottom: 3px; border-bottom: 1px solid #2196f3; }
    #log div.section { background: #fff; border: 1px solid #ccc; margin: 8px 0; padding: 6px;}
    .工事選択欄 { margin-bottom: 12px; }
    textarea { width: 97vw; min-height: 80px; }
    .form-inline {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      width: 100%;
      margin: 0 auto 14px auto;
      flex-wrap: wrap;
    }
    @media (max-width: 800px) {
      html, body { font-size: 18px; }
      .main-content, .container, table { width: 100vw !important; max-width: 100vw !important; }
      .survey-table input[type="text"],
      .survey-table input[type="number"] {
        font-size: 1.09em;
        padding: 10px 5px;
        width: 96vw;
        min-width: 45vw;
        max-width: 98vw;
      }
      th, td { font-size: 1em; padding: 6px 2px; }
      .buttons button { width: 40vw; min-width: 110px; }
      .project-bar { flex-direction: column; align-items: stretch; gap: 5px; }
      .tabbar { font-size: 0.95em; }
      .tabbar button { font-size: 0.93em; min-width: 60px; }
      .form-inline { flex-direction: column; align-items: stretch; }
    }
    #longTable input[type="text"],
    #longTable input[type="number"] {
      width: 99%;
      min-width: 70px;
      max-width: 350px;
      font-size: 1.13em;
      padding: 3px 8px;
      box-sizing: border-box;
      height: 2em;
    }
    @media (max-width: 800px) {
      #longTable input[type="text"],
      #longTable input[type="number"] {
        width: 96vw;
        min-width: 60vw;
        max-width: 98vw;
        font-size: 1.1em;
        padding: 3px 8px;
        height: 2em;
      }
    }
    #pavementTable input[type="text"],
    #pavementTable input[type="number"],
    #pavementTable select {
      width: 99%;
      min-width: 70px;
      max-width: 350px;
      font-size: 1.08em;
      padding: 3px 8px;
      box-sizing: border-box;
      height: 2em;
    }
    @media (max-width: 800px) {
      #pavementTable input[type="text"],
      #pavementTable input[type="number"],
      #pavementTable select {
        width: 95vw;
        min-width: 40vw;
        max-width: 99vw;
        font-size: 1.08em;
        padding: 3px 8px;
        height: 2em;
      }
    }
    #logPavement { margin-top: 16px; }
    /* ---- スマホ・タブレット対応 テーブル内input重なり防止 ---- */
.survey-table, .survey-table table {
  display: block;
  width: 100vw;
  max-width: 100vw;
  overflow-x: auto;
}
.survey-table table {
  min-width: 700px;  /* テーブルの横幅。カラム数によって700~900に調整可 */
  width: 100%;
  table-layout: fixed;
}
.survey-table th, .survey-table td {
  min-width: 80px;
  padding: 6px 2px;
}
/* テーブルセル内input・selectは100%でセルにピッタリ */
.survey-table input[type="text"],
.survey-table input[type="number"],
.survey-table select {
  width: 100% !important;
  min-width: 0 !important;
  max-width: 100% !important;
  font-size: 1em;
  box-sizing: border-box;
  padding: 7px 3px;
  margin: 0;
}
/* テーブル外フォームのinputは従来通り */
@media (max-width: 800px) {
  .survey-table th, .survey-table td {
    min-width: 70px;
    font-size: 0.97em;
    padding: 5px 1px;
  }
  .survey-table table { min-width: 550px; }
}
/* 入力不可（readonly/disabled）のinputやselectを灰色背景に */
input[readonly], input:disabled, select:disabled, textarea:disabled, textarea[readonly] {
  background: #eee !important;
  color: #666 !important;
  cursor: not-allowed;
}
/* ★図形キャンバスの横スクロール対応 */
#drawCanvas { touch-action: none; max-width: 98vw; background: #fff; display: block; margin: 0 auto; }
#drawImages img { margin: 8px 0; border:1px solid #888; max-width: 95vw; display:block; }
  </style>
</head>
<body>
  <div class="project-bar">
    <label>作業中の工事：</label>
    <select id="sidebarProjectSel" onchange="sidebarSwitchProject()"></select>
  </div>
  <div class="tabbar">
    <button class="tab active" onclick="switchTab('project')">工事設定</button>
    <button class="tab" onclick="switchTab('cross')">横断測量</button>
    <button class="tab" onclick="switchTab('long')">縦断測量</button>
    <button class="tab" onclick="switchTab('pavement')">舗装計算</button>
    <button class="tab" onclick="switchTab('curve')">道路曲線計算</button>
    <button class="tab" onclick="switchTab('memo')">メモ</button>
    <button class="tab" onclick="switchTab('log')">記録</button>
    <button class="tab" onclick="switchTab('drawing')">図形</button>
  </div>
  <div class="main-content">
    <!-- ここまで既存のタブ -->
    <!-- 工事設定 -->
    <div id="project" class="container active">
      <h2>工事情報の登録・切替</h2>
      <div class="form-inline">
        <label>工事名：<input type="text" id="projectName" style="font-size:1.04em;padding:8px;min-width:160px;"></label>
        <button class="add-btn" onclick="addProject()">追加</button>
        <button class="delete-btn" onclick="deleteProject()">この工事を削除</button>
      </div>
      <div id="prjList"></div>
    </div>
    <!-- 横断測量 -->
    <div id="cross" class="container">
      <label>測点：</label><input type="text" id="point" style="font-size:1.03em;min-width:64px;">
      <label>方向：</label>
      <select id="direction" style="font-size:1.03em;min-width:64px;">
        <option value="左">左</option>
        <option value="右">右</option>
      </select>
      <table id="crossTable" class="survey-table">
        <thead>
          <tr>
            <th>横(m)</th>
            <th>縦(m)</th>
            <th>備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="buttons">
        <button onclick="addCrossRow()">行を追加</button>
        <button onclick="registerCross()">登録</button>
        <button onclick="clearCross()">クリア</button>
      </div>
    </div>
    <!-- 縦断測量 -->
    <div id="long" class="container">
      <table id="longTable" class="survey-table">
        <thead>
          <tr>
            <th>測点</th>
            <th>単距</th>
            <th>追距</th>
            <th>BS</th>
            <th>FS</th>
            <th>⊿</th>
            <th>GH</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="buttons">
        <button onclick="addLongRow()">行を追加</button>
        <button onclick="registerLong()">登録</button>
        <button onclick="clearLong()">クリア</button>
      </div>
    </div>
    <!-- 舗装計算 -->
    <div id="pavement" class="container">
      <table id="pavementTable" class="survey-table">
        <thead>
          <tr>
            <th>舗装種類</th>
            <th>測点</th>
            <th>幅員</th>
            <th>単距</th>
            <th>追距</th>
            <th>平均幅員</th>
            <th>面積</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="6" style="text-align:right;">合計</td>
            <td id="areaTotalCell"></td>
          </tr>
        </tfoot>
      </table>
      <div class="buttons">
        <button onclick="addPavementRow()">行を追加</button>
        <button onclick="registerPavement()">登録</button>
        <button onclick="clearPavement()">クリア</button>
      </div>
    </div>
    <!-- 道路曲線計算 -->
    <div id="curve" class="container">
      <label>IP No</label><br>
      <input type="text" id="ipno" placeholder="例: IP-001"><br>
      <label>IA（例: 331900）</label><br>
      <input type="number" id="ia"><br>
      <label>R（半径）</label><br>
      <input type="number" id="r"><br>
      <div class="buttons">
        <button onclick="calculateCurve()">計算する</button>
        <button onclick="registerCurve()">登録</button>
      </div>
      <div id="curveResult" class="record"></div>
    </div>
    <!-- メモ -->
    <div id="memo" class="container">
      <h2>現場メモ</h2>
      <textarea id="memoText" placeholder="ここに現場や工事のメモを記入できます"></textarea>
      <div class="buttons">
        <button onclick="saveMemo()">保存</button>
      </div>
      <div id="memoSaved" class="record"></div>
    </div>
    <!-- 記録タブ -->
    <div id="log" class="container">
      <div class="工事選択欄">
        <label>工事を選択：
          <select id="logProjectSel" onchange="updateLogTab()"></select>
        </label>
        <button class="danger-btn" onclick="clearAllProjects()">全工事＆記録一括削除</button>
      </div>
      <h2>記録（カテゴリ別）</h2>
      <div style="margin:8px 0;">
        <button class="warn-btn" onclick="clearCategory('cross')">横断測量 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('long')">縦断測量 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('pavement')">舗装計算 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('curve')">道路曲線計算 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('memo')">メモ削除</button>
      </div>
      <div id="logCross"></div>
      <div id="logLong"></div>
      <div id="logPavement"></div>
      <div id="logCurve"></div>
      <div id="logMemo"></div>
    </div>
    <!-- 図形タブ -->
    <div id="drawing" class="container">
      <h2>簡易図形メモ</h2>
      <canvas id="drawCanvas" width="360" height="360" style="border:1px solid #666; touch-action:none;"></canvas>
      <div style="margin-top:8px;">
        <button onclick="setDrawMode('line')">線</button>
        <button onclick="setDrawMode('text')">テキスト</button>
        <button onclick="saveDrawing()">保存</button>
        <button onclick="clearCanvas()">クリア</button>
      </div>
      <div id="drawMessage" style="margin-top:4px;font-size:0.97em;color:#007acc;"></div>
      <div id="drawImages"></div>
    </div>
  </div>
<script>
let projects = JSON.parse(localStorage.getItem("projects3") || "[]");
let activeProject = localStorage.getItem("activeProject3") || (projects[0]?.id || null);
function projectKey(p) { return p.name; }
function keyOfActive() {
  const p = projects.find(x=>x.id===activeProject);
  return p ? projectKey(p) : "";
}
// ・・・（ここに既存の各種関数たち。省略せず貼り付けてOK）・・・
/* ★既存の関数群はそのまま（省略） */

// ========== ▼▼▼ ここから図形タブ用の追加 ▼▼▼ ==========
let drawMode = "line";
let drawing = false, lastX = 0, lastY = 0;
let drawRecords = JSON.parse(localStorage.getItem("drawRecords3") || "[]");

// モード切替
function setDrawMode(mode){
  drawMode = mode;
  document.getElementById('drawMessage').textContent =
    mode==="text" ? "キャンバス内をタップしてテキスト入力" : "線モード";
}

// 描画初期化＆イベント
function setupDrawingCanvas(){
  const canvas = document.getElementById("drawCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  // 線モード
  canvas.addEventListener("pointerdown", function(e){
    if(drawMode==="line"){
      drawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }
  });
  canvas.addEventListener("pointermove", function(e){
    if(drawMode==="line" && drawing){
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.strokeStyle = "#007acc";
      ctx.lineWidth = 2;
      ctx.stroke();
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }
  });
  canvas.addEventListener("pointerup", ()=> drawing = false);
  canvas.addEventListener("pointerleave", ()=> drawing = false);
  // テキストモード
  canvas.addEventListener("pointerdown", function(e){
    if(drawMode==="text"){
      let text = prompt("入力するテキスト・数字を入れてください","");
      if(text){
        ctx.fillStyle = "#333";
        ctx.font = "bold 18px sans-serif";
        ctx.fillText(text, e.offsetX, e.offsetY);
      }
    }
  });
}

// 保存・表示・クリア
function saveDrawing(){
  const canvas = document.getElementById("drawCanvas");
  const img = canvas.toDataURL();
  drawRecords.push({time:new Date().toLocaleString(), img});
  localStorage.setItem("drawRecords3", JSON.stringify(drawRecords));
  document.getElementById('drawMessage').textContent = "保存しました";
  renderDrawImages();
}
function clearCanvas(){
  const canvas = document.getElementById("drawCanvas");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
}
function renderDrawImages(){
  let html = "<h3>保存履歴</h3>";
  drawRecords.slice().reverse().forEach(rec=>{
    html += `<div><img src="${rec.img}"><div style="font-size:0.9em;color:#555;">${rec.time}</div></div>`;
  });
  document.getElementById("drawImages").innerHTML = html;
}
// ========== ▲▲▲ ここまで図形タブ用の追加 ▲▲▲ ==========

window.onload = () => {
  renderProjectSelects();
  initializeCrossTable();
  clearLongTable();
  clearPavementTable();
  updateLogTab();
  setupDrawingCanvas();      // ←★図形タブのcanvas初期化
  renderDrawImages();        // ←★履歴の初期描画
};
</script>
</body>
</html>

</script>
</body>
</html>
