<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d47a1">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>道路ツール</title>
  <link rel="stylesheet" href="style.css">
  <!-- 視認性向上のためGoogle Fonts (Noto Sans JP) を利用（任意） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
</head>
<body>
  
  <!-- 上部固定ヘッダー -->
  <header class="app-header">
    <div class="project-selector">
      <label for="sidebarProjectSel">工事:</label>
      <select id="sidebarProjectSel" onchange="sidebarSwitchProject()"></select>
    </div>
    <button id="calcCallBtn" class="btn-icon" onclick="openCalcModal()" aria-label="電卓">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/></svg>
      電卓
    </button>
  </header>

  <!-- タブナビゲーション -->
  <nav class="tabbar-wrapper">
    <div class="tabbar">
      <button class="tab active" data-tab="project" onclick="switchTab('project')">工事設定</button>
      <button class="tab" data-tab="point-tab" onclick="switchTab('point-tab')">測点</button>
      <button class="tab" data-tab="cross" onclick="switchTab('cross')">横断測量</button>
      <button class="tab" data-tab="testCross" onclick="switchTab('testCross')">テスト横断</button>      <button class="tab" data-tab="long" onclick="switchTab('long')">縦断測量</button>
      <button class="tab" data-tab="pavement" onclick="switchTab('pavement')">舗装計算</button>
      <button class="tab" data-tab="curve" onclick="switchTab('curve')">道路曲線</button>
      <button class="tab" data-tab="vcurve" onclick="switchTab('vcurve')">縦断曲線</button>
      <button class="tab" data-tab="mass" onclick="switchTab('mass')">土方カーブ</button>
      <button class="tab" data-tab="drawing" onclick="switchTab('drawing')">図形</button>
      <button class="tab" data-tab="memo" onclick="switchTab('memo')">メモ</button>
      <button class="tab" data-tab="log" onclick="switchTab('log')">記録</button>
      <button class="tab" data-tab="disclaimer" onclick="switchTab('disclaimer')">情報</button>
    </div>
  </nav>

  <main class="main-content">
    
    <!-- 工事設定 -->
    <div id="project" class="container active">
      <!-- 工事情報カード -->
      <div class="card">
        <div class="card-header">
          <h2>工事情報の登録・切替</h2>
        </div>
        <div class="card-body">
          <div class="form-group-row">
            <label class="input-label">工事名</label>
            <input type="text" id="projectName" placeholder="工事名を入力">
            <div class="btn-group">
              <button class="btn btn-primary" onclick="addProject()">追加</button>
              <button class="btn btn-danger-outline" onclick="deleteProject()">削除</button>
            </div>
          </div>
          <div id="prjList" class="info-list"></div>
        </div>
      </div>

      <!-- 測点設定カード -->
      <!-- バックアップインポートカード -->
      <div class="card">
        <div class="card-header">
          <h2>データ復元（インポート）</h2>
        </div>
        <div class="card-body">
          <p class="text-sm text-muted">バックアップJSONファイルを読み込んでデータを復元します。</p>
          <div class="form-stack mt-2">
            <input type="file" id="backupFileInput" accept=".json" class="file-input-control">
            <button class="btn btn-warning full-width" onclick="importBackup()">インポート実行</button>
          </div>
          <div id="backupImportStatus" class="status-msg mt-2"></div>
        </div>
      </div>
    </div>

    <!-- 測点タブ -->
    <div id="point-tab" class="container">
      <div class="card">
        <div class="card-header flex-between">
          <h2>測点設定</h2>
          <div class="mode-switch">
            <label><input type="radio" name="pointMode" value="manual" checked> 手動入力</label>
            <label><input type="radio" name="pointMode" value="auto"> オートフィル</label>
          </div>
        </div>
        <div class="card-body">
          <div id="point-mode-manual">
            <div class="table-wrapper">
              <table id="pointTable" class="survey-table">
                <thead>
                  <tr><th>測点</th><th>単距</th><th>追距</th><th>備考</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="point-mode-auto" class="is-hidden">
            <div class="form-grid">
              <div class="input-group">
                <label>開始単距</label>
                <input type="number" id="autoStart" placeholder="例: 0">
              </div>
              <div class="input-group">
                <label>終了単距</label>
                <input type="number" id="autoEnd" placeholder="例: 200">
              </div>
              <div class="input-group">
                <label>ピッチ(m)</label>
                <input type="number" id="autoPitch" placeholder="例: 20">
              </div>
              <div class="input-group full-width">
                <label>主要点(BC,ECなど)</label>
                <textarea id="autoMajorPoints" rows="4" placeholder="例: BC,35.5&#10;EC,120.0"></textarea>
                <small class="text-sm text-muted">1行ごとに「名称,単距」で入力してください。</small>
              </div>
            </div>
          </div>
        </div>
        <div id="point-manual-actions" class="card-footer">
          <button class="btn btn-secondary" onclick="addPointRow()">＋ 行を追加</button>
          <button class="btn btn-success" onclick="savePointSettings()">登録</button>
        </div>
        <div id="point-auto-actions" class="card-footer is-hidden">
          <button class="btn btn-primary" onclick="runAutoFill()">オートフィル生成</button>
        </div>
      </div>
    </div>

    <!-- 横断測量 -->
    <div id="cross" class="container">
      <div class="card">
        <div class="card-header sticky-controls">
          <div class="form-inline-group">
            <div class="input-wrapper">
              <label>測点</label>
              <input id="pointSel" list="pointList" placeholder="No.">
              <datalist id="pointList"></datalist>
            </div>
            <div class="input-wrapper">
              <label>方向</label>
              <input type="hidden" id="direction" value="左">
              <div class="direction-toggle cross-direction-toggle">
                <button id="crossLeftBtn" class="btn btn-secondary btn-toggle active" data-direction="左">左へ ◀</button>
                <button id="crossRightBtn" class="btn btn-secondary btn-toggle" data-direction="右">▶ 右へ</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body no-padding">
          <div class="table-wrapper">
            <table id="crossTable" class="survey-table">
              <thead>
                <tr>
                  <th style="width: 30%">横(m)</th>
                  <th style="width: 30%">縦(m)</th>
                  <th>備考</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" onclick="addCrossRow()">＋ 行を追加</button>
          <div class="btn-pair">
            <button class="btn btn-success" onclick="registerCross()">登録</button>
          </div>
        </div>
      </div>
    </div>

    <!-- テスト横断 -->
    <div id="testCross" class="container">
      <div class="card">
        <div class="card-header">
          <h2>テスト横断（ポール横断）</h2>
        </div>
        <div class="card-body">
          <div class="test-cross-section">
            <p class="section-label">方向切替</p>
            <div class="direction-toggle">
              <button id="testCrossLeftBtn" class="btn btn-secondary btn-large btn-toggle" data-direction="left">左へ ◀</button>
              <button id="testCrossRightBtn" class="btn btn-secondary btn-large btn-toggle active" data-direction="right">▶ 右へ</button>
            </div>
          </div>
          <div class="test-cross-section">
            <p class="section-label">ステータス</p>
            <div class="test-cross-status">
              現在の起点からの離れ: <span id="testCrossAbsH">0.000</span>m,
              標高: <span id="testCrossAbsV">0.000</span>m
            </div>
          </div>
          <div class="test-cross-section">
            <p class="section-label">入力</p>
            <div class="test-cross-inputs">
              <div class="input-group">
                <label for="testCrossH">水平距離(H)</label>
                <input id="testCrossH" type="number" inputmode="decimal" placeholder="例: 1.20">
              </div>
              <div class="input-group">
                <label for="testCrossV">高低差(V)</label>
                <input id="testCrossV" type="number" inputmode="decimal" placeholder="例: -0.20">
              </div>
              <div class="input-group full-width">
                <label for="testCrossSL">SL(斜距離)</label>
                <input id="testCrossSL" type="number" inputmode="decimal" placeholder="勾配選択時に自動分解">
              </div>
              <div class="input-group full-width">
                <label for="testCrossMemo">備考</label>
                <input id="testCrossMemo" type="text" placeholder="例: As舗">
              </div>
            </div>
            <div class="test-cross-actions">
              <button class="btn btn-primary btn-large" data-action="add">追加</button>
              <button class="btn btn-secondary btn-large" data-action="clear">クリア</button>
            </div>
          </div>
          <div class="test-cross-section">
            <p class="section-label">勾配ショートカット</p>
            <div class="test-cross-presets">
              <button class="btn btn-secondary btn-large preset-btn active" data-slope="0.3" data-label="3分(0.3)">3分(0.3)</button>
              <button class="btn btn-secondary btn-large preset-btn" data-slope="0.4" data-label="4分(0.4)">4分(0.4)</button>
              <button class="btn btn-secondary btn-large preset-btn" data-slope="1" data-label="1割(1.0)">1割(1.0)</button>
            </div>
            <p id="testCrossSlopeLabel" class="text-sm text-muted">選択中勾配: 3分(0.3)</p>
          </div>
          <div class="test-cross-section">
            <p class="section-label">備考クイックタグ</p>
            <div class="test-cross-tags">
              <button class="btn btn-outline btn-large" data-tag="As舗">As舗</button>
              <button class="btn btn-outline btn-large" data-tag="Con舗">Con舗</button>
              <button class="btn btn-outline btn-large" data-tag="3分ブロックSL">3分ブロックSL</button>
              <button class="btn btn-outline btn-large" data-tag="2分ブロックSL">2分ブロックSL</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>断面プレビュー</h2>
        </div>
        <div class="card-body">
          <div class="canvas-container test-cross-canvas">
            <canvas id="testCrossCanvas" width="340" height="240"></canvas>
          </div>
          <div class="table-wrapper">
            <table class="survey-table dense-table">
              <thead>
                <tr>
                  <th>離れ(m)</th>
                  <th>標高(m)</th>
                  <th>備考</th>
                </tr>
              </thead>
              <tbody id="testCrossList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 縦断測量 -->
    <div id="long" class="container">
      <div class="card">
        <div class="card-body no-padding">
          <div class="table-wrapper">
            <table id="longTable" class="survey-table dense-table">
              <thead>
                <tr>
                  <th>測点</th>
                  <th>単距</th>
                  <th>追距</th>
                  <th>BS</th>
                  <th>FS</th>
                  <th>⊿</th>
                  <th>GH</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" onclick="addLongRow()">＋ 行を追加</button>
          <div class="btn-group-right">
            <button class="btn btn-warning" onclick="clearLong()">クリア</button>
            <button class="btn btn-success" onclick="registerLong()">登録</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 舗装計算 -->
    <div id="pavement" class="container">
      <div class="card">
        <div class="card-body no-padding">
          <div class="table-wrapper">
            <table id="pavementTable" class="survey-table dense-table">
              <thead>
                <tr>
                  <th style="min-width:110px">舗装種類</th>
                  <th>測点</th>
                  <th>単距</th>
                  <th>追距</th>
                  <th>幅員</th>
                  <th>平均幅員</th>
                  <th>面積</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="6" class="text-right">As計</td>
                  <td id="asphaltAreaCell" class="result-cell"></td>
                </tr>
                <tr>
                  <td colspan="6" class="text-right">Con計</td>
                  <td id="concreteAreaCell" class="result-cell"></td>
                </tr>
                <tr>
                  <td colspan="6" class="text-right">OL計</td>
                  <td id="overlayAreaCell" class="result-cell"></td>
                </tr>
                <tr>
                  <td colspan="6" class="text-right">As+Con計</td>
                  <td id="asConAreaCell" class="result-cell"></td>
                </tr>
                <tr class="total-row">
                  <td colspan="6" class="text-right">合計</td>
                  <td id="areaTotalCell" class="result-cell"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" onclick="addPavementRow()">＋ 行を追加</button>
          <div class="btn-group-right">
            <button class="btn btn-outline" onclick="exportPavementExcel()">Excel出力</button>
            <button class="btn btn-warning" onclick="clearPavement()">クリア</button>
            <button class="btn btn-success" onclick="registerPavement()">登録</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 道路曲線計算 -->
    <div id="curve" class="container text-center-container">
      <div class="card">
        <div class="card-header">
          <h2>道路曲線諸元</h2>
        </div>
        <div class="card-body">
          <div class="form-stack">
            <div class="input-group">
              <label>IP No</label>
              <input type="text" id="ipno" placeholder="例: IP.1">
            </div>
            <div class="input-group">
              <label>IA <small>(例:33°19'00" → 331900)</small></label>
              <input type="number" id="ia" placeholder="331900">
            </div>
            <div class="input-group">
              <label>R (半径)</label>
              <input type="number" id="r" placeholder="半径 m">
            </div>
          </div>
          <div class="btn-group-center">
            <button class="btn btn-primary" onclick="calculateCurve()">計算する</button>
            <button class="btn btn-success" onclick="registerCurve()">登録</button>
          </div>
          <div id="curveResult" class="result-area"></div>
        </div>
      </div>
    </div>

    <!-- 縦断曲線 -->
    <div id="vcurve" class="container text-center-container">
      <div class="card">
        <div class="card-header">
          <h2>縦断曲線 (VCL)</h2>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="input-group">
              <label>IP位置</label>
              <input type="number" id="vcIP">
            </div>
            <div class="input-group">
              <label>VCL (m)</label>
              <input type="number" id="vcVCL">
            </div>
            <div class="input-group">
              <label>左勾配 G1(%)</label>
              <input type="number" id="vcG1">
            </div>
            <div class="input-group">
              <label>右勾配 G2(%)</label>
              <input type="number" id="vcG2">
            </div>
            <div class="input-group full-width">
              <label>起点 GH</label>
              <input type="number" id="vcGH0">
            </div>
          </div>
          <div class="btn-group-center">
            <button class="btn btn-primary" onclick="calculateVCurve()">計算する</button>
          </div>
          <div id="vcurveResult" class="result-area"></div>
        </div>
      </div>
    </div>

    <!-- 土方カーブ -->
    <div id="mass" class="container text-center-container">
      <div class="card">
        <div class="card-header">
          <h2>土方カーブ (Mass)</h2>
        </div>
        <div class="card-body">
          <div class="form-stack">
            <div class="input-group">
              <label>弦長 C(m)</label>
              <input type="number" id="massChordC">
            </div>
            <div class="input-group">
              <label>曲線半径 R(m)</label>
              <input type="number" id="massChordR">
            </div>
          </div>
          <div class="btn-group-center">
            <button class="btn btn-primary" onclick="calculateMassChord()">計算する</button>
          </div>
          <div id="massChordResult" class="result-area"></div>
        </div>
        <div class="card-body no-padding border-top">
          <div class="table-wrapper">
             <table id="massTable" class="survey-table">
              <thead>
                 <tr><th>測点</th><th>切土</th><th>盛土</th><th>区間V</th><th>累計V</th></tr>
              </thead>
              <tbody></tbody>
             </table>
          </div>
        </div>
        <div class="card-footer">
           <button class="btn btn-secondary" onclick="addMassRow()">＋ 行を追加</button>
           <button class="btn btn-warning" onclick="clearMass()">クリア</button>
           <button class="btn btn-success" onclick="registerMass()">登録</button>
        </div>
      </div>
    </div>

    <!-- メモ -->
    <div id="memo" class="container">
      <div class="card">
        <div class="card-header">
          <h2>現場メモ</h2>
        </div>
        <div class="card-body">
          <textarea id="memoText" rows="8" placeholder="ここに現場や工事のメモを記入できます..."></textarea>
          <div id="memoSaved" class="status-msg"></div>
        </div>
        <div class="card-footer">
          <button class="btn btn-success full-width" onclick="saveMemo()">保存</button>
        </div>
      </div>
    </div>

    <!-- 図形タブ -->
    <div id="drawing" class="container">
      <div class="card">
        <div class="card-body">
          <div class="drawing-toolbar">
            <div class="tool-group">
              <button class="draw-mode-btn" data-mode="line" onclick="setDrawMode('line')">線</button>
              <button class="draw-mode-btn" data-mode="text" onclick="setDrawMode('text')">文字</button>
              <button class="draw-mode-btn" data-mode="number" onclick="setDrawMode('number')">数字</button>
              <button class="draw-mode-btn" data-mode="freehand" onclick="setDrawMode('freehand')">自由</button>
            </div>
            <div class="tool-actions">
              <button class="btn-icon-small" onclick="undoDrawing()" aria-label="戻る">↩</button>
              <button class="btn-icon-small" onclick="redoDrawing()" aria-label="進む">↪</button>
              <button class="btn-icon-small danger" onclick="clearDrawing()" aria-label="クリア">✕</button>
            </div>
            <span id="drawModeLabel" class="mode-badge"></span>
          </div>

          <div class="canvas-container">
            <canvas id="drawingCanvas" width="340" height="340"></canvas>
          </div>

          <div class="draw-controls">
            <div class="input-with-label">
              <span>x</span>
              <input type="number" id="inputDX" step="0.1" class="draw-input" placeholder="m">
            </div>
            <div class="input-with-label">
              <span>y</span>
              <input type="number" id="inputDY" step="0.1" class="draw-input" placeholder="m">
            </div>
            <button onclick="addRelativeLine()" id="addLineBtn" class="btn btn-primary btn-sm">追加</button>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-success full-width" onclick="saveDrawing()">記録</button>
        </div>
        <div id="drawingLog" class="log-area"></div>
      </div>
    </div>

    <!-- 記録タブ -->
    <div id="log" class="container">
      <div class="card warning-card">
        <div class="card-body">
          <div class="log-filter">
            <label>記録の表示：</label>
            <select id="logProjectSel" onchange="updateLogTab()"></select>
          </div>
          <button class="btn btn-danger full-width mt-2" onclick="clearAllProjects()">⚠ 全データ完全消去</button>
        </div>
      </div>

      <div class="log-sections">
        <!-- 横断測量 -->
        <div class="card">
          <div class="card-header flex-between">
            <h3>横断測量</h3>
            <button class="btn btn-danger-text" onclick="clearCategory('cross')">削除</button>
          </div>
          <div id="logCross" class="card-body log-content"></div>
        </div>
        
        <!-- 縦断測量 -->
        <div class="card">
          <div class="card-header flex-between">
            <h3>縦断測量</h3>
            <button class="btn btn-danger-text" onclick="clearCategory('long')">削除</button>
          </div>
          <div id="logLong" class="card-body log-content"></div>
        </div>

        <!-- 舗装計算 -->
        <div class="card">
          <div class="card-header flex-between">
            <h3>舗装計算</h3>
            <button class="btn btn-danger-text" onclick="clearCategory('pavement')">削除</button>
          </div>
          <div id="logPavement" class="card-body log-content"></div>
        </div>

        <!-- 道路曲線 -->
        <div class="card">
          <div class="card-header flex-between">
             <h3>道路曲線</h3>
             <button class="btn btn-danger-text" onclick="clearCategory('curve')">削除</button>
          </div>
          <div id="logCurve" class="card-body log-content"></div>
        </div>

        <!-- 土方カーブ -->
        <div class="card">
           <div class="card-header flex-between">
             <h3>土方カーブ</h3>
             <button class="btn btn-danger-text" onclick="clearCategory('mass')">削除</button>
           </div>
           <div id="logMass" class="card-body log-content"></div>
        </div>

        <!-- メモ -->
        <div class="card">
          <div class="card-header flex-between">
             <h3>メモ</h3>
             <button class="btn btn-danger-text" onclick="clearCategory('memo')">削除</button>
          </div>
          <div id="logMemo" class="card-body log-content"></div>
        </div>
      </div>
    </div>

    <div id="disclaimer" class="container">
      <div class="card">
        <div class="card-body text-center">
          <p class="text-muted">
            本Webアプリは現状のまま無保証で提供しています。利用による一切の損害について、作者は責任を負いません。業務・商用利用の際は必ずご自身で検証してください。
          </p>
        </div>
      </div>
    </div>

  </main>

  <!-- 電卓 (モーダル) -->
  <div id="calc" class="container calc-modal">
    <div class="calc-wrapper">
      <input id="calcDisplay" type="text" readonly class="calc-display">
      <div class="calc-body">
        <div class="calc-top">
          <button class="btn-calc danger-text" onclick="clearCalc()">AC</button>
          <button class="btn-calc" onclick="backspaceCalc()">⌫</button>
        </div>
        <div class="calc-grid">
          <button onclick="appendCalc('7')">7</button>
          <button onclick="appendCalc('8')">8</button>
          <button onclick="appendCalc('9')">9</button>
          <button class="op" onclick="appendCalc('/')">÷</button>
          
          <button onclick="appendCalc('4')">4</button>
          <button onclick="appendCalc('5')">5</button>
          <button onclick="appendCalc('6')">6</button>
          <button class="op" onclick="appendCalc('*')">×</button>
          
          <button onclick="appendCalc('1')">1</button>
          <button onclick="appendCalc('2')">2</button>
          <button onclick="appendCalc('3')">3</button>
          <button class="op" onclick="appendCalc('-')">−</button>
          
          <button onclick="appendCalc('0')">0</button>
          <button onclick="appendCalc('.')">.</button>
          <button class="func" onclick="copyCalc()">Copy</button>
          <button class="op" onclick="appendCalc('+')">+</button>
        </div>
        <div class="calc-parens">
          <button class="func" onclick="appendCalc('(')">(</button>
          <button class="func" onclick="appendCalc(')')">)</button>
        </div>
        <div class="calc-bottom">
          <button class="btn-equal" onclick="evaluateCalc()">＝</button>
        </div>
        <div id="calcMsg" class="calc-msg"></div>
      </div>
    </div>
  </div>

  <div id="calcOverlay" class="calc-overlay" onclick="closeCalcModal()"></div>

  <script src="main.js"></script>
</body>
</html>





