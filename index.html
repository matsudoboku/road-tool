<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007acc">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script>
function safeParseJSON(raw, fallback){
  try{
    return raw ? JSON.parse(raw) : fallback;
  }catch(e){
    console.error("Failed to parse JSON", e, raw);
    return fallback;
  }
}

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function() {
        navigator.serviceWorker.register("service-worker.js");
      });
    }
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=yes">
  <title>道路ツール</title>
  <style>
 html, body {
  background: #f5f5f5;
  margin: 0;
  padding: 0;
  font-size: 18px;
  font-family: sans-serif;
  width: 100vw;
  min-height: 100vh;
  box-sizing: border-box;
}
.project-bar {
  width: 100vw;
  background: #e3f2fd;
  border-bottom: 2px solid #007acc;
  padding: 8px 8px 8px 8px;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  gap: 10px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.project-bar label {
  font-size: 1em;
  color: #007acc;
  font-weight: bold;
  margin-right: 4px;
}
.project-bar select {
  font-size: 1em;
  padding: 5px 10px;
  border-radius: 5px;
}
.tabbar {
  display: flex;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  white-space: nowrap;
  width: 100vw;
  background: #164361;
  border-bottom: 2px solid #007acc;
  box-sizing: border-box;
  z-index: 90;
  padding-bottom: 4px;
  gap: 6px;
}
.tabbar button {
  flex: 0 0 auto;
  min-width: 92px;
  white-space: nowrap;
  font-size: 1.02em;
  padding: 11px 19px;
  border: none;
  background: #164361;
  color: #fff;
  border-bottom: 4px solid transparent;
  transition: border-bottom .2s, background .15s;
  font-weight: normal;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-right: 0;
}
.tabbar button.active {
  background: #007acc;
  color: #fff;
  border-bottom: 4px solid #ffdc57;
  font-weight: bold;
}
.tabbar::-webkit-scrollbar {
  display: none;
}

.main-content {
  width: 100vw;
  padding: 0;
  margin: 0;
  box-sizing: border-box;
}
.container {
  display: none;
  width: 100vw;
  box-sizing: border-box;
  margin: 0 auto;
  padding: 10px 0 40px 0;
  overflow-x: auto;
}
.container.active { display: block; }

/* 横断測量の入力欄を1行にまとめる */
.cross-head {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 6px;
}
.cross-head #point {
  width: 68px;
}

input, select, textarea {
  font-size: 1.05em;
  padding: 8px 10px;
  border-radius: 5px;
  border: 1px solid #bbb;
  margin: 2px 0;
  box-sizing: border-box;
}
table {
  border-collapse: collapse;
  margin: 12px 0 0 0;
  background: #fff;
  width: 100%;
  max-width: 100%;
  table-layout: fixed;
}
th, td {
  border: 1px solid #ddd;
  padding: 4px;
  font-size: 1em;
  text-align: center;
  min-width: 56px;
}
th {
  background: #e3f2fd;
  font-weight: bold;
  font-size: 1.04em;
}
/* 共通：テーブルのインプット幅調整 */
.survey-table input[type="text"],
.survey-table input[type="number"],
.survey-table select {
  width: 100%;
  margin: 0;
  border: none;
  border-radius: 0;
  padding: 6px 4px;
  box-sizing: border-box;
}

/* 入力幅の調整用クラス */
.wide-input,
.mid-input,
.narrow-input,
.remark-input {
  width: 96%;
  box-sizing: border-box;
}
/* レスポンシブ */
@media (max-width: 800px) {
  html, body { font-size: 17px; }
  .main-content, .container, table { width: 100vw !important; max-width: 100vw !important; }
  th, td { font-size: 0.98em; padding: 5px 2px; }
  .buttons button { width: 44vw; min-width: 110px; }
  .project-bar { flex-direction: column; align-items: stretch; gap: 5px; }
  .tabbar { font-size: 0.98em; }
  .tabbar button { font-size: 0.96em; min-width: 84px; padding: 11px 7px; }
  .form-inline { flex-direction: column; align-items: stretch; }
  .cross-head { flex-wrap: wrap; }
  #longTable input[type="text"],
  #longTable input[type="number"] {
    width: 98%;
    min-width: 60px;
    max-width: 98%;
    font-size: 1.09em;
    padding: 5px 4px;
  }
  #pavementTable input[type="text"],
  #pavementTable input[type="number"],
  #pavementTable select {
    width: 98%;
    min-width: 60px;
    max-width: 98%;
    font-size: 1.08em;
    padding: 5px 4px;
  }
}

/* 入力不可（readonly/disabled）のinputやselectを灰色背景に */
input[readonly], input:disabled, select:disabled, textarea:disabled, textarea[readonly] {
  background: #eee !important;
  color: #666 !important;
  cursor: not-allowed;
}
.survey-table {
  border: 2px solid #888;
  box-sizing: border-box;
}
.survey-table th,
.survey-table td {
  border: 1.5px solid #888;
}
#crossTable input[type="text"],
#crossTable input[type="number"] {
  width: 96%;
}

/* スマホで値が切れないようテーブル幅を最小化しつつ横スクロールを許可 */
#crossTable { min-width: 360px; }
#longTable  { min-width: 600px; }
@media (max-width: 800px) {
#crossTable input[type="text"],
#crossTable input[type="number"] {
  width: 100%;
　}
}
  </style>
</head>
<body>
  <div class="project-bar">
    <label>作業中の工事：</label>
    <select id="sidebarProjectSel" onchange="sidebarSwitchProject()"></select>
  </div>
  <div class="tabbar">
    <button class="tab active" data-tab="project" onclick="switchTab('project')">工事設定</button>
    <button class="tab" data-tab="cross" onclick="switchTab('cross')">横断測量</button>
    <button class="tab" data-tab="long" onclick="switchTab('long')">縦断測量</button>
    <button class="tab" data-tab="pavement" onclick="switchTab('pavement')">舗装計算</button>
    <button class="tab" data-tab="curve" onclick="switchTab('curve')">道路曲線計算</button>
    <button class="tab" data-tab="memo" onclick="switchTab('memo')">メモ</button>
    <button class="tab" data-tab="drawing" onclick="switchTab('drawing')">図形</button>
    <button class="tab" data-tab="log" onclick="switchTab('log')">記録</button>
  </div>
  <div class="main-content">
    <!-- 工事設定 -->
    <div id="project" class="container active">
      <h2>工事情報の登録・切替</h2>
      <div class="form-inline">
        <label>工事名：<input type="text" id="projectName" style="font-size:1.04em;padding:8px;min-width:160px;"></label>
        <button class="add-btn" onclick="addProject()">追加</button>
        <button class="delete-btn" onclick="deleteProject()">この工事を削除</button>
      </div>
      <div id="prjList"></div>
    </div>
    <!-- 横断測量 -->
    <div id="cross" class="container">
      <div class="cross-head">
        <label>測点：</label>
        <input type="text" id="point" style="font-size:1.03em;">
        <label>方向：</label>
        <select id="direction" style="font-size:1.03em;">
        <option value="左">左</option>
        <option value="右">右</option>
        </select>
      </div>
      <table id="crossTable" class="survey-table">
        <thead>
          <tr>
            <th>横(m)</th>
            <th>縦(m)</th>
            <th>備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="buttons">
        <button onclick="addCrossRow()">行を追加</button>
        <button onclick="registerCross()">登録</button>
        <button onclick="clearCross()">クリア</button>
      </div>
    </div>
    <!-- 縦断測量 -->
    <div id="long" class="container">
      <table id="longTable" class="survey-table">
        <thead>
          <tr>
            <th>測点</th>
            <th>単距</th>
            <th>追距</th>
            <th>BS</th>
            <th>FS</th>
            <th>⊿</th>
            <th>GH</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="buttons">
        <button onclick="addLongRow()">行を追加</button>
        <button onclick="registerLong()">登録</button>
        <button onclick="clearLong()">クリア</button>
      </div>
    </div>
    <!-- 舗装計算 -->
    <div id="pavement" class="container">
      <table id="pavementTable" class="survey-table">
        <thead>
          <tr>
             <th>舗装種類</th>
              <th>測点</th>
              <th>単距</th>
              <th>追距</th>
              <th>幅員</th>
              <th>平均幅員</th>
              <th>面積</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="6" style="text-align:right;">アスファルト計</td>
            <td id="asphaltAreaCell"></td>
          </tr>
          <tr>
            <td colspan="6" style="text-align:right;">コンクリート計</td>
            <td id="concreteAreaCell"></td>
          </tr>
          <tr>
            <td colspan="6" style="text-align:right;">オーバーレイ計</td>
            <td id="overlayAreaCell"></td>
          </tr>
          <tr>
            <td colspan="6" style="text-align:right;">合計</td>
            <td id="areaTotalCell"></td>
          </tr>
        </tfoot>
      </table>
      <div class="buttons">
        <button onclick="addPavementRow()">行を追加</button>
        <button onclick="registerPavement()">登録</button>
        <button onclick="clearPavement()">クリア</button>
        <button onclick="exportPavementExcel()">Excel出力</button>
      </div>
    </div>
    <!-- 道路曲線計算 -->
    <div id="curve" class="container">
      <label>IP No</label><br>
      <input type="text" id="ipno" placeholder="例: IP-001"><br>
      <label>IA（例: 331900）</label><br>
      <input type="number" id="ia"><br>
      <label>R（半径）</label><br>
      <input type="number" id="r"><br>
      <div class="buttons">
        <button onclick="calculateCurve()">計算する</button>
        <button onclick="registerCurve()">登録</button>
      </div>
      <div id="curveResult" class="record"></div>
    </div>
    <!-- メモ -->
    <div id="memo" class="container">
      <h2>現場メモ</h2>
      <textarea id="memoText" placeholder="ここに現場や工事のメモを記入できます"></textarea>
      <div class="buttons">
        <button onclick="saveMemo()">保存</button>
      </div>
      <div id="memoSaved" class="record"></div>
    </div>
    <!-- 簡易図形タブの本体を追加 -->
    <div id="drawing" class="container">
      <h2>簡易図形メモ</h2>
      <div style="margin-bottom:12px;">
        <button onclick="setDrawMode('line')">線</button>
        <button onclick="setDrawMode('text')">テキスト</button>
        <button onclick="setDrawMode('number')">数字</button>
        <button onclick="clearDrawing()">クリア</button>
        <span id="drawModeLabel"></span>
      </div>
      <canvas id="drawingCanvas" width="340" height="340" style="border:1px solid #aaa; background:#fff; touch-action:none; width:97vw;max-width:380px;"></canvas>
      <div style="margin:8px 0;">
        <button onclick="saveDrawing()">記録</button>
      </div>
      <div id="drawingLog"></div>
    </div>
    <!-- 記録タブ -->
    <div id="log" class="container">
      <div class="工事選択欄">
        <label>工事を選択：
          <select id="logProjectSel" onchange="updateLogTab()"></select>
        </label>
        <button class="danger-btn" onclick="clearAllProjects()">全工事＆記録一括削除</button>
      </div>
      <h2>記録（カテゴリ別）</h2>
      <div style="margin:8px 0;">
        <button class="warn-btn" onclick="clearCategory('cross')">横断測量 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('long')">縦断測量 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('pavement')">舗装計算 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('curve')">道路曲線計算 記録削除</button>
        <button class="warn-btn" onclick="clearCategory('memo')">メモ削除</button>
      </div>
      <div id="logCross"></div>
      <div id="logLong"></div>
      <div id="logPavement"></div>
      <div id="logCurve"></div>
      <div id="logMemo"></div>
    </div>
  </div>
<script>
let projects = safeParseJSON(localStorage.getItem("projects3"), []);
let activeProject = localStorage.getItem("activeProject3") || (projects[0] ? projects[0].id : null);
function projectKey(p) { return p.name; }
function keyOfActive() {
  const p = projects.find(x=>x.id===activeProject);
  return p ? projectKey(p) : "";
}
function sidebarSwitchProject() {
  activeProject = document.getElementById("sidebarProjectSel").value;
  localStorage.setItem("activeProject3", activeProject);
  renderProjectSelects();
  updateLogTab();
}
function switchTab(tabId) {
  // タブとコンテナ両方のactiveを一度クリア
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".container").forEach(c => c.classList.remove("active"));
  // data-tab属性がtabIdと一致するものをactive
  const tabBtn = document.querySelector(`.tab[data-tab="${tabId}"]`);
  const tabCont = document.getElementById(tabId);
  if(tabBtn) tabBtn.classList.add("active");
  if(tabCont) tabCont.classList.add("active");
  if(tabId === "log") updateLogTab();
  if(tabId === "memo") loadMemo();
}

function addCrossRow() {
  const tbody = document.querySelector("#crossTable tbody");
  const row = tbody.insertRow();
  row.insertCell().innerHTML = `<input type="number" class="mid-input">`;
  row.insertCell().innerHTML = `<input type="number" class="mid-input">`;
  row.insertCell().innerHTML = `<input type="text" class="remark-input">`;
}
function initializeCrossTable() {
  const tbody = document.querySelector("#crossTable tbody");
  tbody.innerHTML = "";
  for (let i = 0; i < 10; i++) {
    addCrossRow();
  }
}
function registerCross() {
  if(!activeProject){ alert("工事を選択してください"); return; }
  const point = document.getElementById("point").value.trim();
  const dir = document.getElementById("direction").value;
  if (!point) return alert("測点を入力してください");
  const rows = document.querySelectorAll("#crossTable tbody tr");
  let rowData = [];
  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const values = Array.from(inputs).map(input => input.value.trim());
    if (values.some(v => v)) rowData.push(values);
  });
  let allLogs = safeParseJSON(localStorage.getItem("crossLogs3"), {});
  const k = keyOfActive();
  if(!allLogs[k]) allLogs[k]=[];
  allLogs[k].push({ point, dir, rowData, time: new Date().toLocaleString() });
  localStorage.setItem("crossLogs3", JSON.stringify(allLogs));
  initializeCrossTable();
  document.getElementById("point").value = "";
  updateLogTab();
}
function clearCross() {
  if (confirm("すべての入力内容を削除します。よろしいですか？")) {
    document.getElementById("point").value = "";
    initializeCrossTable();
  }
}
function addLongRow() {
  const tbody = document.querySelector("#longTable tbody");
  const row = tbody.insertRow();
  row.insertCell().innerHTML = `<input type="text" class="wide-input">`;
  row.insertCell().innerHTML = `<input type="number" class="mid-input">`;
  row.insertCell().innerHTML = `<input type="number" class="mid-input" readonly tabindex="-1">`;
  row.insertCell().innerHTML = `<input type="number" class="narrow-input">`;
  row.insertCell().innerHTML = `<input type="number" class="narrow-input">`;
  row.insertCell().innerHTML = `<input type="number" class="narrow-input" readonly tabindex="-1">`;
  row.insertCell().innerHTML = `<input type="number" class="wide-input" readonly tabindex="-1">`;
  const inputs = row.querySelectorAll("input");
  inputs[1].addEventListener("input", () => calculateLong());
  inputs[3].addEventListener("input", () => {
    if(inputs[3].value !== ""){
      inputs[4].value = "";
      inputs[4].setAttribute("readonly", true);
    }else{
      inputs[4].removeAttribute("readonly");
    }
    calculateLong();
  });
  inputs[4].addEventListener("input", () => {
    if(inputs[4].value !== ""){
      inputs[3].value = "";
      inputs[3].setAttribute("readonly", true);
    }else{
      inputs[3].removeAttribute("readonly");
    }
    calculateLong();
  });
}
function calculateLong() {
  const rows = document.querySelectorAll("#longTable tbody tr");
  let prevGH = null, prevDelta = null, prevTsui = 0;
  rows.forEach((row, i) => {
    const cells = row.querySelectorAll("input");
    const tankyo = parseFloat(cells[1].value) || 0;
    let tsui = (i === 0) ? tankyo : (prevTsui + tankyo);
    cells[2].value = tankyo === 0 ? "" : tsui;
    prevTsui = tsui;
    const bs = parseFloat(cells[3].value);
    const fs = parseFloat(cells[4].value);
    if (cells[3].value !== "") {
      cells[4].value = "";
      cells[4].setAttribute("readonly", true);
    } else {
      cells[4].removeAttribute("readonly");
    }
    if (cells[4].value !== "") {
      cells[3].value = "";
      cells[3].setAttribute("readonly", true);
    } else {
      cells[3].removeAttribute("readonly");
    }
    if (i === 0) {
      if (!cells[6].value) {
        let gh = prompt("初期GHを入力してください", "");
        if (gh === null || gh.trim() === "" || isNaN(parseFloat(gh))) return;
        cells[6].value = parseFloat(gh).toFixed(2);
      }
      prevGH = parseFloat(cells[6].value);
      let delta = prevGH;
      if (!isNaN(bs)) { delta = prevGH + bs; }
      cells[5].value = delta.toFixed(2);
      prevDelta = delta;
    } else {
      let prevRow = rows[i-1];
      let prevGHfromRow = parseFloat(prevRow.querySelectorAll("input")[6].value);
      let delta = prevDelta;
      if (!isNaN(bs) && !isNaN(prevGHfromRow)) {
        delta = prevGHfromRow + bs;
      }
      cells[5].value = delta !== null ? delta.toFixed(2) : "";
      if (!isNaN(fs) && delta !== null) {
        let gh = delta - fs;
        cells[6].value = gh.toFixed(2);
        prevGH = gh; prevDelta = delta;
      } else {
        cells[6].value = "";
        prevGH = delta; prevDelta = delta;
      }
    }
  });
}
function registerLong() {
  if(!activeProject){ alert("工事を選択してください"); return; }
  const rows = document.querySelectorAll("#longTable tbody tr");
  let allLogs = safeParseJSON(localStorage.getItem("longLogs3"), {});
  let tableRows = [];
  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const point = inputs[0].value;
    const tankyo = inputs[1].value;
    const tsuikyo = inputs[2].value;
    const bs = inputs[3].value;
    const fs = inputs[4].value;
    const delta = inputs[5].value;
    const gh = inputs[6].value;
    if (point || tankyo || tsuikyo || bs || fs || delta || gh) {
      tableRows.push({ point, tankyo, tsuikyo, bs, fs, delta, gh });
    }
  });
  if (tableRows.length > 0) {
    const k = keyOfActive();
    if(!allLogs[k]) allLogs[k]=[];
    allLogs[k].push({ tableRows, time: new Date().toLocaleString() });
    localStorage.setItem("longLogs3", JSON.stringify(allLogs));
  }
  updateLogTab();
  clearLongTable();
}
function clearLongTable() {
  document.querySelector("#longTable tbody").innerHTML = "";
  for (let i = 0; i < 10; i++) addLongRow();
}
function clearLong() {
  if (confirm("縦断測量のすべてのデータを削除します。よろしいですか？")) {
    clearLongTable();
  }
}
function addPavementRow() {
  const tbody = document.querySelector('#pavementTable tbody');
  const row = tbody.insertRow();
  // 順番を「舗装種類｜測点｜単距｜追距｜幅員｜平均幅員｜面積」にする
  row.insertCell().innerHTML = `
    <select onchange="propagatePavementType(this)">
      <option value="アスファルト">アスファルト</option>
      <option value="コンクリート">コンクリート</option>
      <option value="オーバーレイ">オーバーレイ</option>
    </select>
  `;
  row.insertCell().innerHTML = `<input type="text" oninput="updatePavementTable()">`;   // 測点
  row.insertCell().innerHTML = `<input type="number" oninput="updatePavementTable()">`; // 単距
  row.insertCell().innerHTML = `<input type="number" readonly tabindex="-1">`;         // 追距
  row.insertCell().innerHTML = `<input type="number" oninput="updatePavementTable()">`; // 幅員
  row.insertCell().innerHTML = `<input type="number" readonly tabindex="-1">`;         // 平均幅員
  row.insertCell().innerHTML = `<input type="number" readonly tabindex="-1">`;         // 面積
  updatePavementTable();
}
  function propagatePavementType(sel){
  const rows = document.querySelectorAll("#pavementTable tbody tr");
  const currentRow = sel.closest("tr");
  const index = Array.from(rows).indexOf(currentRow);
  for(let i=index+1;i<rows.length;i++){
    const s = rows[i].querySelector("select");
    if(s) s.value = sel.value;
  }
  updatePavementTable();
}

function updatePavementTable() {
  const rows = document.querySelectorAll('#pavementTable tbody tr');
  let prevTsuikyo = 0, prevHani = 0, areaTotal = 0;
  let areaMap = { 'アスファルト':0, 'コンクリート':0, 'オーバーレイ':0 };
  rows.forEach((row, i) => {
    const select = row.querySelector('select');
    const inputs = row.querySelectorAll('input');
    // 順番：[測点, 単距, 追距, 幅員, 平均幅員, 面積]
    const tankyo = parseFloat(inputs[1].value) || 0;  // 単距
    let tsuikyo = (i === 0) ? tankyo : (prevTsuikyo + tankyo);
    inputs[2].value = tankyo ? tsuikyo : '';          // 追距
    prevTsuikyo = tsuikyo;

    const hani = parseFloat(inputs[3].value) || 0;    // 幅員
    let avgHani = (i === 0) ? hani : ((hani + prevHani) / 2);
    inputs[4].value = hani ? avgHani.toFixed(2) : ''; // 平均幅員
    prevHani = hani;

    let area = (tankyo && avgHani) ? (tankyo * avgHani) : '';
    inputs[5].value = area ? area.toFixed(2) : '';    // 面積
    areaTotal += parseFloat(inputs[5].value) || 0;
    if(area){
      areaMap[select.value] += parseFloat(area);
    }
  });
  document.getElementById('areaTotalCell').textContent = areaTotal.toFixed(2);
  document.getElementById('asphaltAreaCell').textContent = areaMap['アスファルト'].toFixed(2);
  document.getElementById('concreteAreaCell').textContent = areaMap['コンクリート'].toFixed(2);
  document.getElementById('overlayAreaCell').textContent = areaMap['オーバーレイ'].toFixed(2);
}
function clearPavementTable() {
  document.querySelector('#pavementTable tbody').innerHTML = '';
  for(let i=0;i<10;i++) addPavementRow();
  updatePavementTable();

}
function clearPavement() {
  if (confirm("舗装計算のすべてのデータを削除します。よろしいですか？")) {
    clearPavementTable();
  }
}
function registerPavement() {
  if(!activeProject){ alert("工事を選択してください"); return; }
  const rows = document.querySelectorAll("#pavementTable tbody tr");
  let pavementLogs = safeParseJSON(localStorage.getItem("pavementLogs3"), {});
  let tableRows = [];
  let areaMap = { 'アスファルト':0, 'コンクリート':0, 'オーバーレイ':0 };
  rows.forEach(row => {
    const select = row.querySelector('select');
    const inputs = row.querySelectorAll('input');
    const type = select.value;
    const point   = inputs[0].value;
    const tankyo  = inputs[1].value;
    const tsuikyo = inputs[2].value;
    const hani    = inputs[3].value;
    const avgHani = inputs[4].value;
    const area    = inputs[5].value;
    if(type || point || tankyo || tsuikyo || hani || avgHani || area){
      tableRows.push({type, point, tankyo, tsuikyo, hani, avgHani, area});
      areaMap[type] += parseFloat(area) || 0;
    }
  });
  let areaTotal = document.getElementById('areaTotalCell').textContent;
  if (tableRows.length > 0) {
    const k = keyOfActive();
    if(!pavementLogs[k]) pavementLogs[k]=[];
    pavementLogs[k].push({ tableRows, areaTotal, areaMap, time: new Date().toLocaleString() });
    localStorage.setItem("pavementLogs3", JSON.stringify(pavementLogs));
  }
  updateLogTab();
  clearPavementTable();
}
function exportPavementExcel() {
  updatePavementTable();
  const rows = document.querySelectorAll('#pavementTable tbody tr');
  let csv = '舗装種類,測点,単距,追距,幅員,平均幅員,面積\n';
  rows.forEach(row => {
    const sel = row.querySelector('select').value;
    const inputs = row.querySelectorAll('input');
    const vals = [inputs[0].value, inputs[1].value, inputs[2].value, inputs[3].value, inputs[4].value, inputs[5].value];
    if(sel || vals.some(v => v)) {
      csv += [sel, ...vals].join(',') + '\n';
    }
  });
  const asphalt = document.getElementById('asphaltAreaCell').textContent;
  const concrete = document.getElementById('concreteAreaCell').textContent;
  const overlay = document.getElementById('overlayAreaCell').textContent;
  const total = document.getElementById('areaTotalCell').textContent;
  csv += `アスファルト計,,,,,,${asphalt}\n`;
  csv += `コンクリート計,,,,,,${concrete}\n`;
  csv += `オーバーレイ計,,,,,,${overlay}\n`;
  csv += `合計,,,,,,${total}\n`;
  const blob = new Blob(['\uFEFF' + csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pavement.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function updateLogTab() {
  const prjId = document.getElementById("logProjectSel").value;
  const p = projects.find(x=>x.id===prjId);
  const k = p ? projectKey(p) : "";
  const crossLogs = safeParseJSON(localStorage.getItem("crossLogs3"), {});
  let logsArr = crossLogs[k] || [];
  let htmlCross = `<h3>横断測量</h3><hr>`;
  logsArr.forEach(log => {
    htmlCross += `<div class="section"><b>【測点${log.point} - ${log.dir}】</b><br>`;
    htmlCross += `<table class="survey-table"><tr><th>横(m)</th><th>縦(m)</th><th>備考</th></tr>`;
    log.rowData.forEach(r => {
      htmlCross += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`;
    });
    htmlCross += `</table></div>`;
  });
  document.getElementById("logCross").innerHTML = htmlCross;
  const longLogs = safeParseJSON(localStorage.getItem("longLogs3"), {});
  let lArr = longLogs[k] || [];
  let htmlLong = `<h3>縦断測量</h3><hr>`;
  lArr.forEach(log => {
    htmlLong += `<div class="section"><table class="survey-table"><tr>
      <th>測点</th><th>単距</th><th>追距</th><th>BS</th><th>FS</th><th>⊿</th><th>GH</th>
      </tr>`;
    log.tableRows.forEach(row => {
      htmlLong += `<tr>
        <td>${row.point}</td>
        <td>${row.tankyo}</td>
        <td>${row.tsuikyo}</td>
        <td>${row.bs}</td>
        <td>${row.fs}</td>
        <td>${row.delta}</td>
        <td>${row.gh}</td>
      </tr>`;
    });
    htmlLong += `</table></div>`;
  });
  document.getElementById("logLong").innerHTML = htmlLong;
  const pavementLogs = safeParseJSON(localStorage.getItem("pavementLogs3"), {});
  let pArr = pavementLogs[k] || [];
  let htmlPave = `<h3>舗装計算</h3><hr>`;
  pArr.forEach(log => {
    htmlPave += `<div class="section"><table class="survey-table"><tr>
      <th>舗装種類</th><th>測点</th><th>幅員</th><th>単距</th><th>追距</th><th>平均幅員</th><th>面積</th>
      </tr>`;
    log.tableRows.forEach(row => {
      htmlPave += `<tr>
        <td>${row.type}</td>
        <td>${row.point}</td>
        <td>${row.hani}</td>
        <td>${row.tankyo}</td>
        <td>${row.tsuikyo}</td>
        <td>${row.avgHani}</td>
        <td>${row.area}</td>
      </tr>`;
    });
    htmlPave += `<tr>
        <td colspan="6" style="text-align:right;">アスファルト計</td>
        <td>${(log.areaMap && log.areaMap['アスファルト'] ? parseFloat(log.areaMap['アスファルト']).toFixed(2) : '0.00')}</td>
      </tr>`;
    htmlPave += `<tr>
        <td colspan="6" style="text-align:right;">コンクリート計</td>
        <td>${(log.areaMap && log.areaMap['コンクリート'] ? parseFloat(log.areaMap['コンクリート']).toFixed(2) : '0.00')}</td>
      </tr>`;
    htmlPave += `<tr>
        <td colspan="6" style="text-align:right;">オーバーレイ計</td>
        <td>${(log.areaMap && log.areaMap['オーバーレイ'] ? parseFloat(log.areaMap['オーバーレイ']).toFixed(2) : '0.00')}</td>
      </tr>`;
    htmlPave += `<tr>
        <td colspan="6" style="text-align:right;">合計</td>
        <td>${log.areaTotal}</td>
      </tr>`;
    htmlPave += `</table>日時:${log.time}</div>`;
  });
  document.getElementById("logPavement").innerHTML = htmlPave;
  const curveLogs = safeParseJSON(localStorage.getItem("curveLogs3"), {});
  let cArr = curveLogs[k] || [];
  let htmlCurve = `<h3>道路曲線計算</h3><hr>`;
  cArr.forEach(log => {
    htmlCurve += `<div class="section"><table class="survey-table">
      <tr><th>IP No</th><th>IA</th><th>R</th><th>TL</th><th>SL</th><th>CL</th><th>CL/2</th><th>MC</th></tr>
      <tr>
        <td>${log.ipNo || ""}</td>
        <td>${log.iaStr || ""}</td>
        <td>${log.r || ""}</td>
        <td>${log.tl || ""}</td>
        <td>${log.sl || ""}</td>
        <td>${log.cl || ""}</td>
        <td>${log.cl2 || ""}</td>
        <td>${log.mc || ""}</td>
      </tr>
    </table></div>`;
  });
  document.getElementById("logCurve").innerHTML = htmlCurve;
  const allMemos = safeParseJSON(localStorage.getItem("memoLogs3"), {});
  let memo = allMemos[k] || "";
  document.getElementById("logMemo").innerHTML = `<h3>現場メモ</h3><div class="section">${memo.replace(/\n/g,"<br>")}</div>`;
}
function clearCategory(cat) {
  const prjId = document.getElementById("logProjectSel").value;
  const p = projects.find(x=>x.id===prjId);
  if(!p) return;
  const k = projectKey(p);
  let keyMap = {cross: "crossLogs3", long: "longLogs3", pavement: "pavementLogs3", curve: "curveLogs3", memo: "memoLogs3"};
  if(!keyMap[cat]) return;
  if(!confirm("本当にこの工事の「"+{cross:"横断測量",long:"縦断測量",pavement:"舗装計算",curve:"道路曲線計算",memo:"メモ"}[cat]+"」記録を削除しますか？")) return;
  let all = safeParseJSON(localStorage.getItem(keyMap[cat]), {});
  if(all[k]) delete all[k];
  localStorage.setItem(keyMap[cat], JSON.stringify(all));
  updateLogTab();
}
function addProject() {
  const name = document.getElementById('projectName').value.trim();
  if(!name) return alert("工事名を入力してください");
  if(projects.some(x=>x.name === name)) return alert("同じ工事名は登録できません");
  const id = Date.now().toString();
  projects.push({id, name});
  localStorage.setItem("projects3", JSON.stringify(projects));
  activeProject = id;
  localStorage.setItem("activeProject3", activeProject);
  renderProjectSelects();
  alert("工事を追加・切替しました");
}
function renderProjectSelects() {
  const sbs = document.getElementById("sidebarProjectSel");
  const lgs = document.getElementById("logProjectSel");
  sbs.innerHTML = lgs.innerHTML = "";
  projects.forEach(p => {
    const sel = `<option value="${p.id}" ${p.id===activeProject?"selected":""}>${p.name}</option>`;
    sbs.innerHTML += sel; lgs.innerHTML += sel;
  });
  let txt = "";
  projects.forEach((p,i) => {
    txt += `・${i+1}（${p.name}）<br>`;
  });
  document.getElementById("prjList").innerHTML = txt;
}
function deleteProject() {
  if(!activeProject) return;
  const p = projects.find(x=>x.id===activeProject);
  if(!p) return;
  if(!confirm("この工事（"+p.name+"）と記録を完全削除します。よろしいですか？")) return;
  projects = projects.filter(x=>x.id !== activeProject);
  localStorage.setItem("projects3", JSON.stringify(projects));
  const k = projectKey(p);
  ["crossLogs3", "longLogs3", "pavementLogs3", "curveLogs3", "memoLogs3"].forEach(key=>{
    let all = safeParseJSON(localStorage.getItem(key), {});
    if(all[k]) delete all[k];
    localStorage.setItem(key, JSON.stringify(all));
  });
  activeProject = projects[0] ? projects[0].id : null;
  localStorage.setItem("activeProject3", activeProject);
  renderProjectSelects();
  updateLogTab();
}
function clearAllProjects() {
  if(!confirm("すべての工事設定および記録を完全削除します。よろしいですか？")) return;
  localStorage.removeItem("projects3");
  localStorage.removeItem("activeProject3");
  ["crossLogs3", "longLogs3", "pavementLogs3", "curveLogs3", "memoLogs3"].forEach(k=>localStorage.removeItem(k));
  projects = [];
  activeProject = null;
  renderProjectSelects();
  updateLogTab();
}
function saveMemo() {
  if(!activeProject){ alert("工事を選択してください"); return; }
  const memo = document.getElementById("memoText").value.trim();
  let allMemos = safeParseJSON(localStorage.getItem("memoLogs3"), {});
  const k = keyOfActive();
  allMemos[k] = memo;
  localStorage.setItem("memoLogs3", JSON.stringify(allMemos));
  document.getElementById("memoSaved").textContent = "保存しました";
  updateLogTab();
}
function loadMemo() {
  if(!activeProject) { document.getElementById("memoText").value = ""; return; }
  let allMemos = safeParseJSON(localStorage.getItem("memoLogs3"), {});
  const k = keyOfActive();
  document.getElementById("memoText").value = allMemos[k] || "";
  document.getElementById("memoSaved").textContent = "";
}
window.onload = () => {
  renderProjectSelects();
  initializeCrossTable();
  clearLongTable();
  clearPavementTable();
  updateLogTab();
  switchTab('project');
};
// --- 図形タブ（簡易お絵描き＋数字/テキスト） --- //
let drawMode = "line";
let drawing = false;
let startX, startY;
let canvas, ctx;
let drawObjects = [];
let selectedObj = null;
let lastX, lastY;
let savedDrawings = safeParseJSON(localStorage.getItem("drawingLogs3"), {});

function setDrawMode(mode) {
  drawMode = mode;
  drawing = false;
  selectedObj = null;
  document.getElementById("drawModeLabel").textContent = `モード: ${mode === 'line' ? '線' : mode === 'text' ? 'テキスト' : '数字'}`;
}

function getCanvasCtx() {
  if (!canvas) {
    canvas = document.getElementById("drawingCanvas");
    ctx = canvas.getContext("2d");
  }
}
function clearCanvas() {
  getCanvasCtx();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}
function clearDrawing(){
  drawObjects = [];
  clearCanvas();
}
function redraw(){
  clearCanvas();
  drawObjects.forEach(obj=>{
    if(obj.type==='line'){
      ctx.beginPath();
      ctx.moveTo(obj.x1, obj.y1);
      ctx.lineTo(obj.x2, obj.y2);
      ctx.strokeStyle="#1c1c1c"; ctx.lineWidth=2;
      ctx.stroke();
    }else if(obj.type==='text'){
      ctx.font="20px sans-serif";
      ctx.fillStyle="#ca6b00";
      ctx.fillText(obj.text, obj.x, obj.y);
    }
  });
}
function distToSegment(px,py,x1,y1,x2,y2){
  const A=px-x1, B=py-y1, C=x2-x1, D=y2-y1;
  const dot=A*C+B*D;
  const lenSq=C*C+D*D;
  let param= lenSq? dot/lenSq : -1;
  let xx,yy;
  if(param<0){ xx=x1; yy=y1; }
  else if(param>1){ xx=x2; yy=y2; }
  else{ xx=x1+param*C; yy=y1+param*D; }
  const dx=px-xx, dy=py-yy;
  return Math.sqrt(dx*dx+dy*dy);
}
function findObjectAt(x,y){
  getCanvasCtx();
  for(let i=drawObjects.length-1;i>=0;i--){
    const obj=drawObjects[i];
    if(obj.type==='line'){
      if(distToSegment(x,y,obj.x1,obj.y1,obj.x2,obj.y2)<=6) return obj;
    }else if(obj.type==='text'){
      ctx.font="20px sans-serif";
      const w=ctx.measureText(obj.text).width;
      const h=20;
      if(x>=obj.x && x<=obj.x+w && y<=obj.y && y>=obj.y-h) return obj;
    }
  }
  return null;
}
function saveDrawing() {
  getCanvasCtx();
  if(!activeProject){ alert("工事を選択してください"); return; }
  const k = keyOfActive();
  // PNG形式で保存
  let img = canvas.toDataURL("image/png");
  if(!savedDrawings[k]) savedDrawings[k]=[];
  savedDrawings[k].push({img, time: new Date().toLocaleString()});
  localStorage.setItem("drawingLogs3", JSON.stringify(savedDrawings));
  showDrawingLog();
  clearDrawing();
  alert("記録しました");
}
function showDrawingLog() {
  if(!activeProject) return;
  const k = keyOfActive();
  let arr = savedDrawings[k] || [];
  let html = `<h3>図形記録</h3>`;
  arr.forEach(obj => {
    html += `<div style="margin-bottom:8px;"><img src="${obj.img}" style="width:120px;border:1px solid #999;"><br><small>${obj.time}</small></div>`;
  });
  document.getElementById("drawingLog").innerHTML = html;
}

// --- キャンバス描画イベント処理 ---
function setupDrawingCanvas() {
  getCanvasCtx();
  let rect = canvas.getBoundingClientRect();
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  function xy(e) {
    if(e.touches){ // タッチ端末
      let t = e.touches[0] || e.changedTouches[0];
      return {x: t.clientX - rect.left, y: t.clientY - rect.top};
    }else{
      return {x: e.offsetX, y: e.offsetY};
    }
  }
  canvas.onmousedown = function(e){
    let pos = xy(e);
    selectedObj = findObjectAt(pos.x,pos.y);
    if(selectedObj){
      lastX = pos.x; lastY = pos.y;
    }else if(drawMode==='line'){
      drawing = true;
      startX = pos.x; startY = pos.y;
    }
  };
  canvas.onmousemove = function(e){
    let pos = xy(e);
    if(selectedObj){
      const dx = pos.x - lastX;
      const dy = pos.y - lastY;
      if(selectedObj.type==='line'){
        selectedObj.x1 += dx; selectedObj.y1 += dy;
        selectedObj.x2 += dx; selectedObj.y2 += dy;
      }else if(selectedObj.type==='text'){
        selectedObj.x += dx; selectedObj.y += dy;
      }
      lastX = pos.x; lastY = pos.y;
      redraw();
    }else if(drawMode==='line' && drawing){
      redraw();
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle="#1c1c1c"; ctx.lineWidth=2;
      ctx.stroke();
    }
  };
  canvas.onmouseup = function(e){
    let pos = xy(e);
    if(selectedObj){
      selectedObj = null;
    }else if(drawMode==='line' && drawing){
      drawObjects.push({type:'line', x1:startX, y1:startY, x2:pos.x, y2:pos.y});
      drawing = false;
      redraw();
    }
  };
  canvas.onmouseleave = function(){
    if(drawing){ drawing = false; redraw(); }
    selectedObj = null;
  };
  canvas.ontouchstart = function(e){
    let pos = xy(e);
    selectedObj = findObjectAt(pos.x,pos.y);
    if(selectedObj){
      lastX = pos.x; lastY = pos.y;
    }else if(drawMode==='line'){
      drawing = true;
      startX = pos.x; startY = pos.y;
    }
    e.preventDefault();
  };
  canvas.ontouchmove = function(e){
    let pos = xy(e);
    if(selectedObj){
      const dx = pos.x - lastX;
      const dy = pos.y - lastY;
      if(selectedObj.type==='line'){
        selectedObj.x1 += dx; selectedObj.y1 += dy;
        selectedObj.x2 += dx; selectedObj.y2 += dy;
      }else if(selectedObj.type==='text'){
        selectedObj.x += dx; selectedObj.y += dy;
      }
      lastX = pos.x; lastY = pos.y;
      redraw();
    }else if(drawMode==='line' && drawing){
      redraw();
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle="#1c1c1c"; ctx.lineWidth=2;
      ctx.stroke();
    }
    e.preventDefault();
  };
  canvas.ontouchend = function(e){
    let pos = xy(e);
    if(selectedObj){
      selectedObj = null;
    }else if(drawMode==='line' && drawing){
      drawObjects.push({type:'line', x1:startX, y1:startY, x2:pos.x, y2:pos.y});
      drawing = false;
      redraw();
    }else if(drawMode === 'text' || drawMode === 'number'){
      let txt = prompt('入力してください（最大8文字）');
      if(txt){
        txt = txt.substring(0,8);
        drawObjects.push({ type: 'text', x: pos.x, y: pos.y, text: txt });
        redraw();
      }
    }
    e.preventDefault();
  };
  if(!isTouchDevice){
    canvas.onclick = function(e){
      if(selectedObj || drawing) return;
      if(drawMode==='text' || drawMode==='number'){
        let txt = prompt("入力してください（最大8文字）");
        if(!txt) return;
        txt = txt.substring(0,8);
        let pos = xy(e);
        drawObjects.push({type:'text', x:pos.x, y:pos.y, text:txt});
        redraw();
      }
    };
  } else {
    canvas.onclick = null;
  }
}
// 図形タブを開いた時だけキャンバス初期化＆記録表示
const _oldSwitchTab = switchTab;
switchTab = function(tabId){
  _oldSwitchTab(tabId);
  if(tabId==="drawing"){
    setDrawMode("line");
    drawObjects = [];
    setupDrawingCanvas();
    redraw();
    showDrawingLog();
  }
};
let curveResultObj = null; // グローバル変数

function dmsToDecimal(dms) {
  const deg = Math.floor(dms / 10000);
  const min = Math.floor((dms % 10000) / 100);
  const sec = dms % 100;
  return deg + min / 60 + sec / 3600;
}
function decimalToDMS(deg) {
  const d = Math.floor(deg);
  const mFloat = (deg - d) * 60;
  const m = Math.floor(mFloat);
  let s = Math.round((mFloat - m) * 60);
  let mm = m, dd = d;
  if (s === 60) { s = 0; mm += 1; }
  if (mm === 60) { mm = 0; dd += 1; }
  return `${dd}°${mm}′${s}″`;
}

function calculateCurve() {
  const ipNo = document.getElementById("ipno").value;
  const iaInput = document.getElementById("ia").value;
  const r = parseFloat(document.getElementById("r").value);
  if (!iaInput || !r || isNaN(r)) {
    document.getElementById("curveResult").innerHTML = "入力値を確認してください";
    return;
  }
  // GAS式と同じ
  const iaDecimal = dmsToDecimal(parseInt(iaInput, 10));
  const iaRadHalf = (iaDecimal * Math.PI / 180) / 2;

  const tl = r * Math.tan(iaRadHalf);                                      // 接線長 TL
  const sl = r * (1 / Math.cos(iaRadHalf) - 1);                            // SL（GAS式。弦長ではない）
  const cl = r * (iaDecimal * Math.PI / 180);                              // 曲線長 CL
  const clHalf = cl / 2;
  const mcDMS = decimalToDMS((180 - iaDecimal) / 2);                       // MC（角度で返す）

  const iaStr = decimalToDMS(iaDecimal);

  curveResultObj = {
    ipNo: ipNo ? ipNo : "",
    iaStr,
    r,
    tl: tl.toFixed(3),
    sl: sl.toFixed(3),
    cl: cl.toFixed(3),
    cl2: clHalf.toFixed(3),
    mc: mcDMS
  };


  // 結果表示
  document.getElementById("curveResult").innerHTML = `
    <table class="survey-table">
      <tr><th>IP No</th><td>${curveResultObj.ipNo}</td></tr>
      <tr><th>IA</th><td>${curveResultObj.iaStr}</td></tr>
      <tr><th>R</th><td>${curveResultObj.r}</td></tr>
      <tr><th>TL</th><td>${curveResultObj.tl}</td></tr>
      <tr><th>SL</th><td>${curveResultObj.sl}</td></tr>
      <tr><th>CL</th><td>${curveResultObj.cl}</td></tr>
      <tr><th>CL/2</th><td>${curveResultObj.cl2}</td></tr>
      <tr><th>MC</th><td>${curveResultObj.mc}</td></tr>
    </table>`;
}
function registerCurve() {
  if (!curveResultObj) { alert("まず「計算する」を押してください"); return; }
  if (!activeProject) { alert("工事を選択してください"); return; }
  let allLogs = safeParseJSON(localStorage.getItem("curveLogs3"), {});
  const k = keyOfActive();
  if (!allLogs[k]) allLogs[k] = [];
  allLogs[k].push({...curveResultObj, time: new Date().toLocaleString()});
  localStorage.setItem("curveLogs3", JSON.stringify(allLogs));
  curveResultObj = null;
  document.getElementById('curveResult').innerHTML = "登録しました。";
  document.getElementById('ipno').value = "";
  document.getElementById('ia').value = "";
  document.getElementById('r').value = "";
  updateLogTab();
}

</script>
</body>
</html>
